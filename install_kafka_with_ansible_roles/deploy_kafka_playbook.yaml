---
- name: Wait for SSH
  hosts: all
  gather_facts: false
  tasks:
    - name: Ensure VM is reachable over SSH
      wait_for:
        port: 22
        host: "{{ (ansible_ssh_host | default(ansible_host)) | default(inventory_hostname) }}"
        search_regex: OpenSSH
        delay: 10
        timeout: 120
      vars:
        ansible_connection: local

- name: Generate Kafka Controller Quorum Voters (run once on localhost)
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Build kafka_controller_quorum_voters dynamically (with private IPs)
      set_fact:
        kafka_controller_quorum_voters: "{{ (groups['kafka'] | sort | map('extract', hostvars, 'private_ip') | zip(range(1, groups['kafka']|length + 1)) | map('reverse') | map('join', '@') | map('regex_replace', '(.*)', '\\1:9093') | join(',')) }}"
      register: quorum_result

    - name: Display computed quorum voters
      debug:
        msg: "kafka_controller_quorum_voters = {{ kafka_controller_quorum_voters }}"

- name: Prepare broker environment
  hosts: kafka
  become: true
  vars_files:
    - vars
  roles:
    - setup_envirenment

- name: Configure KRaft Kafka brokers
  hosts: kafka
  become: true
  vars_files:
    - vars
  pre_tasks:
    - name: Assign deterministic node id
      set_fact:
        kafka_node_id: "{{ groups['kafka'].index(inventory_hostname) + 1 }}"

    - name: Retrieve kafka_controller_quorum_voters from localhost facts
      set_fact:
        kafka_controller_quorum_voters: "{{ hostvars['localhost']['kafka_controller_quorum_voters'] }}"

  roles:
    - install_kafka

- name: Generate Prometheus targets for Kafka exporters
  hosts: localhost
  connection: local
  vars_files:
    - vars
  gather_facts: false
  tasks:
    - name: Ensure Prometheus target directory exists
      file:
        path: "{{ prometheus_sd_output_path | dirname }}"
        state: directory
        mode: "0755"

    - name: Render Kafka scrape target file
      template:
        src: templates/prometheus_kafka_targets.json.j2
        dest: "{{ prometheus_sd_output_path }}"
        mode: "0644"

