---
# ==============================================================================
# Task: 自动发现第一块空闲数据盘，格式化并挂载
# 依赖: 父 Playbook 必须开启 gather_facts: yes
# ==============================================================================

# 0. 设置默认变量 (如果外部没传 mount_point，默认使用 /data)
- name: Set default mount variables
  set_fact:
    target_mount_point: "{{ mount_point | default('/data') }}"
    target_fstype: "{{ filesystem_type | default('xfs') }}"

# 1. 刷新硬件事实 (防止 facts 缓存导致找不到新盘)
- name: Refresh hardware facts
  setup:
    gather_subset:
      - hardware

# 2. 智能查找空闲磁盘
- name: Find unmounted and unpartitioned disk
  set_fact:
    target_disk: "/dev/{{ item.key }}"
  loop: "{{ ansible_devices | dict2items }}"
  when:
    - item.key is not search("sr|loop|ram")
    - item.key != 'sda'
    # Azure 专属保护：跳过 sdb (临时盘)
    # - item.key != 'sdb'
    # 确保没有分区
    - item.value.partitions | length == 0
    # 确保没有被 LVM 或其他程序占用
    - item.value.holders | length == 0
    # 确保大于 5GB
    - (item.value.size | human_to_bytes) > (5 * 1024 * 1024 * 1024)
  # 找到第一个符合条件的就停止，避免最后一次循环覆盖前面的结果
  run_once: false 
  register: disk_find_result

# 3. 锁定目标磁盘变量
- name: Set my_disk variable
  set_fact:
    my_disk: "{{ (disk_find_result.results | selectattr('ansible_facts.target_disk', 'defined') | map(attribute='ansible_facts.target_disk') | list | first) | default('') }}"

# 4. 如果没找到，打印提示 (但不报错退出，保证脚本健壮性)
- name: Debug disk finding result
  debug:
    msg: "{{ 'Found target disk: ' + my_disk if my_disk != '' else 'No suitable data disk found. Skipping mount.' }}"

# ========================================================
#  核心操作 Block (仅当找到盘时执行)
# ========================================================
- block:
    - name: Ensure filesystem ({{ target_fstype }}) exists on {{ my_disk }}
      community.general.filesystem:
        fstype: "{{ target_fstype }}"
        dev: "{{ my_disk }}"
        force: no # 如果已有文件系统，不要强行抹除，防止数据丢失

    - name: Get UUID of the new device
      command: blkid -s UUID -o value {{ my_disk }}
      register: disk_uuid
      changed_when: false

    - name: Ensure mount point directory exists
      file:
        path: "{{ target_mount_point }}"
        state: directory
        mode: '0755'

    - name: Mount the disk and add to /etc/fstab
      ansible.posix.mount:
        path: "{{ target_mount_point }}"
        src: "UUID={{ disk_uuid.stdout }}"
        fstype: "{{ target_fstype }}"
        opts: defaults,nofail
        state: mounted

    - name: Show Success Message
      debug:
        msg: "Disk {{ my_disk }} has been mounted to {{ target_mount_point }}."

  # Block 的执行条件
  when: my_disk != ""
