---
# ========================================================
#  0. 定义变量 (如果外部没传，就用这里的默认值)
# ========================================================
- name: Set Exporter Variables
  set_fact:
    exporter_version: "0.15.0"
    local_files_dir: "{{ playbook_dir }}/files"
    tar_filename: "mysqld_exporter-0.15.0.linux-amd64.tar.gz"
    extracted_dir: "mysqld_exporter-0.15.0.linux-amd64"
    exporter_bin_path: "/usr/local/bin/mysqld_exporter"
    exporter_config_path: "/etc/.mysqld_exporter.cnf"
    exporter_user_system: "prometheus"
  run_once: true

# ========================================================
#  1. 本地准备 (只在 Ansible 机器上执行一次)
# ========================================================
- name: (Local) Ensure files directory exists
  file:
    path: "{{ local_files_dir }}"
    state: directory
  delegate_to: localhost
  run_once: true

- name: (Local) Check if Exporter tarball exists locally
  stat:
    path: "{{ local_files_dir }}/{{ tar_filename }}"
  register: local_tar_check
  delegate_to: localhost
  run_once: true

- name: (Local) Download Exporter to Controller Node
  get_url:
    url: "https://github.com/prometheus/mysqld_exporter/releases/download/v{{ exporter_version }}/{{ tar_filename }}"
    dest: "{{ local_files_dir }}/{{ tar_filename }}"
  delegate_to: localhost
  run_once: true
  when: not local_tar_check.stat.exists

- name: (Local) Unarchive Exporter locally
  unarchive:
    src: "{{ local_files_dir }}/{{ tar_filename }}"
    dest: "{{ local_files_dir }}"
    creates: "{{ local_files_dir }}/{{ extracted_dir }}/mysqld_exporter"
  delegate_to: localhost
  run_once: true

# ========================================================
#  2. 远程部署 (在每一台数据库服务器上执行)
# ========================================================

# 1. 创建数据库用户
- name: Create MySQL User for Exporter
  community.mysql.mysql_user:
    name: "{{ exporter_user }}"
    password: "{{ exporter_pass }}"
    host: "localhost"
    priv: "*.*:PROCESS,REPLICATION CLIENT,SELECT"
    state: present
    login_user: root
    login_password: "{{ root_pass }}"
  when: inventory_hostname in groups['mysql_master']

# 2. 创建系统用户
- name: Ensure system user 'prometheus' exists
  user:
    name: "{{ exporter_user_system }}"
    shell: /sbin/nologin
    state: present

# 3. 分发二进制文件 (记录变化)
- name: Push Exporter Binary to Remote Servers
  copy:
    src: "{{ local_files_dir }}/{{ extracted_dir }}/mysqld_exporter"
    dest: "{{ exporter_bin_path }}"
    mode: '0755'
    owner: "{{ exporter_user_system }}"
    group: "{{ exporter_user_system }}"
  register: bin_copy

# 4. 创建专用的凭证文件 (记录变化)
- name: Create exporter credentials file
  copy:
    dest: "{{ exporter_config_path }}"
    owner: "{{ exporter_user_system }}"
    group: "{{ exporter_user_system }}"
    mode: '0600'
    content: |
      [client]
      user={{ exporter_user }}
      password={{ exporter_pass }}
  register: conf_copy

# 5. 配置 Systemd (记录变化)
- name: Create Systemd Service File
  copy:
    dest: "/etc/systemd/system/mysqld_exporter.service"
    content: |
      [Unit]
      Description=Prometheus MySQL Exporter
      After=network.target

      [Service]
      User={{ exporter_user_system }}
      Group={{ exporter_user_system }}
      Type=simple
      ExecStart={{ exporter_bin_path }} \
        --config.my-cnf="{{ exporter_config_path }}" \
        --web.listen-address=0.0.0.0:9104
      Restart=always

      [Install]
      WantedBy=multi-user.target
  register: service_copy

# 6. 重启逻辑 (替代 Handlers)
- name: Restart MySQL Exporter if config changed
  service:
    name: mysqld_exporter
    state: restarted
    daemon_reload: yes
    enabled: yes
  # 当二进制、配置文件或 Service 文件发生变化时重启
  when: bin_copy.changed or conf_copy.changed or service_copy.changed

# 7. 兜底启动 (防止没变化但服务挂了的情况)
- name: Ensure MySQL Exporter is started
  service:
    name: mysqld_exporter
    state: started
    enabled: yes

# 8. 验证
- name: Wait for Exporter port 9104
  wait_for:
    port: 9104
    delay: 2
    timeout: 10

- name: Check Exporter Metrics (Look for mysql_up 1)
  uri:
    url: "http://localhost:9104/metrics"
    return_content: yes
  register: metrics_output
  failed_when: "'mysql_up 1' not in metrics_output.content"

- name: Show Success
  debug:
    msg: "Installation Success! MySQL is reachable."
