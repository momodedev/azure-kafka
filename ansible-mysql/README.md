

# Ansible MySQL Deployment Guide

This project automates the deployment of a MySQL 5.7 GTID Cluster.

## 🚀 Quick Start

### 1. Prerequisites
- **Terraform Output**: Ensure you have the `mysql_inventory.ini` file generated by the Terraform (`tf-mysql`) project.
- **Connectivity**: Ansible Controller must have SSH access to target VMs (handled by Terraform).

### 2. Execution Flow

We use a single entry point for the entire deployment.

```bash
# Run the main playbook using the Terraform-generated inventory
# This will:
# 1. Auto-generate secure passwords into 'secrets.yml' (if not present)
# 2. Deploy MySQL 5.7
# 3. Configure GTID Replication
ansible-playbook -i ~/mysql_inventory.ini ansible-mysql/00_main_deploy.yml
```

### 3. Verification & Secrets

- **Passwords**: After the first run, a `secrets.yml` file will be created in the `ansible-mysql/` directory.
  - View it to get the generated `root` and `replication` passwords:
    ```bash
    cat ansible-mysql/secrets.yml
    ```
- **Note**: `secrets.yml` is **git-ignored** for security. Do not commit it.

---

### Playbook Details

### 01_install_mysql_57.yml 功能清单

该脚本用于完成 MySQL 5.7 的基础安装、环境适配及存储目录变更，主要功能如下：

1.  **环境依赖准备**
    *   安装 Ansible 执行所需的 Python 库 (`python3-PyMySQL`)。
    *   安装必要的系统工具 (`wget`, `policycoreutils-python-utils`)，为后续下载和 SELinux 管理做准备。

2.  **源与 GPG 密钥修复**
    *   **跨版本源适配**：下载并安装适用于 EL7 的 MySQL Yum 源（以适配 MySQL 5.7）。
    *   **密钥自动导入**：显式导入 MySQL 2022 和 2023 官方 GPG 密钥，解决因密钥过期导致的安装失败问题。

3.  **自定义数据目录支持 (关键功能)**
    *   支持通过变量 `{{ mysql_datadir }}` 定义数据存储路径（如 `/data/mysql`），而非使用默认的 `/var/lib/mysql`。
    *   自动创建目录结构，并严格设置属主 (`mysql:mysql`) 和权限 (`0750`)。

4.  **自动化 SELinux 策略管理**
    *   针对自定义的数据目录，自动设置正确的 SELinux 上下文 (`mysqld_db_t`)。
    *   执行 `restorecon` 刷新策略，防止因目录变更导致 MySQL 服务被 SELinux 拦截无法启动。

5.  **配置变更与服务接管**
    *   自动修改 `/etc/my.cnf` 配置文件，将 `datadir` 指向新路径。
    *   **智能重启**：仅在配置发生实质变更时触发服务重启。
    *   确保 MySQL 服务开机自启，并验证进程存活状态。


### 02_init_root_password.yml 功能清单

该脚本用于自动化接管 MySQL 初始化后的首次登录与密码重置，主要功能如下：

1.  **自动抓取初始凭证**
    *   自动扫描 `/var/log/mysqld.log` 日志文件。
    *   精准提取 MySQL 初始化时生成的**随机临时 root 密码**。

2.  **强制重置过期密码 (核心功能)**
    *   针对 MySQL 5.7 的安全特性（首次登录强制修改密码），使用 `--connect-expired-password` 参数绕过登录限制。
    *   执行 `ALTER USER` 语句将临时密码修改为 `secrets.yml` 中定义的永久 Root 密码。

3.  **幂等性与自我验证**
    *   **验证机制**：重置后立即尝试使用**新密码**连接数据库执行 `SHOW DATABASES`。
    *   **幂等处理**：如果当前密码已经是新密码（即脚本重复运行），脚本会优雅地忽略重置失败的报错，并通过验证步骤确认最终状态正常。

4.  **敏感信息保护**
    *   通过 `vars_files` 引入外部加密或独立的 `secrets.yml` 文件，避免将明文密码硬编码在脚本逻辑中。


### ensure_mysql_running.yml 功能清单

该脚本用于确保 MySQL 服务处于预期的活跃状态，常作为其他复杂操作的前置或后置保障，功能如下：

1.  **服务状态强制纠偏**
    *   检查 `mysqld` 服务当前状态。如果服务处于停止 (stopped) 或崩溃状态，立即启动它。
    *   确保 Playbook 执行结束后，数据库进程一定是在运行中的。

2.  **开启开机自启**
    *   通过 `enabled: yes` 设置，确保 MySQL 服务被注册到系统启动项中，服务器重启后数据库会自动拉起。

3.  **幂等性维护**
    *   作为维护脚本，它是完全幂等的。如果服务已经在运行，它不会执行任何多余的操作（如重启），只会确认状态，适合反复执行以进行巡检。



### 21_config_gtid.yml 功能清单

该脚本用于修改 MySQL 核心配置，启用 GTID（全局事务标识符）及二进制日志，为后续的主从复制做准备，主要功能如下：

1.  **动态生成唯一 Server ID**
    *   **算法自动计算**：自动截取服务器 IP 地址的最后一段（如 `10.1.0.7` -> `7`）作为 `server-id`。
    *   **冲突避免**：确保集群内每台 MySQL 的 ID 唯一，无需手动维护复杂的配置文件。

2.  **开启 GTID 核心特性**
    *   配置 `gtid_mode=ON` 和 `enforce_gtid_consistency=ON`。
    *   这是现代 MySQL 复制的基础，相比传统复制更稳定、故障恢复（Failover）更简单。

3.  **启用二进制日志 (Binlog)**
    *   强制开启 `log-bin` 并设置格式为 `ROW` 模式（数据一致性最高）。
    *   开启 `log_slave_updates=ON`，允许从库将同步的数据再次记入日志（为级联复制或数据安全性做铺垫）。

4.  **智能重启与服务检查**
    *   **按需重启**：利用 Ansible 的 `blockinfile` 模块管理配置块，仅在配置发生实质变化时才重启 MySQL。
    *   **健康等待**：重启后自动监听 `3306` 端口，确保数据库完全启动就绪后再结束任务。




### 22_init_master_user.yml 功能清单

该脚本仅在主节点（Master）上执行，用于创建并授权主从复制专用的数据库账户，主要功能如下：

1.  **主节点定向配置**
    *   通过 `hosts: mysql_master` 锁定执行范围。
    *   确保操作仅发生在定义为主库的服务器上，不影响从库节点。

2.  **创建复制专用账户**
    *   创建用于主从数据同步的专用 MySQL 用户（用户名/密码由 `secrets.yml` 中的变量控制）。
    *   利用 Ansible 的 `mysql_user` 模块保证操作的幂等性（用户已存在则跳过或更新）。

3.  **最小权限授权 (Least Privilege)**
    *   仅授予该账户 `REPLICATION SLAVE` 权限。
    *   不赋予 SELECT 或其他管理权限，确保即使复制账户泄露，攻击者也无法直接读取或修改业务数据。

4.  **全网段接入许可**
    *   设置 `host: "%"`，允许从库节点从任意 IP 地址发起连接。
    *   （注：这简化了从库扩容流程，无需每增加一个从库 IP 就去主库加一条白名单）。





### 23_join_slaves_gtid.yml 功能清单

该脚本仅在从节点（Slave）上执行，用于配置从库指向主库并启动基于 GTID 的复制链路，主要功能如下：

1.  **自动发现主库地址**
    *   利用 Ansible 的 `groups['mysql_master'][0]` 变量自动获取 inventory 中定义的主库 IP。
    *   无需手动硬编码主库 IP，增强了 Playbook 的通用性和灵活性。

2.  **智能状态检测 (Pre-check)**
    *   在执行操作前，先通过 `getreplica` 模式检查当前节点的复制状态。
    *   **防重复执行**：如果发现当前已经是正常的 Slave 状态（IO 线程已在运行），则自动跳过配置步骤，避免破坏现有同步。

3.  **GTID 自动定位 (Auto Position)**
    *   配置从库时启用 `primary_auto_position: yes` (即 `MASTER_AUTO_POSITION = 1`)。
    *   **零手动定位**：不再需要繁琐的 `binlog file` 和 `binlog position` 坐标，从库会根据 GTID 自动寻找断点并同步数据。

4.  **全自动启动与验证**
    *   自动执行 `START SLAVE` (startreplica)。
    *   **双线程校验**：最后一步会强制检查 `Slave_IO_Running` 和 `Slave_SQL_Running` 是否都为 `Yes`。如果任一线程未启动，任务将标记为失败，确保部署结果的可靠性。





### 30_deploy_mysql_exporter.yml 功能清单

该脚本用于在 MySQL 集群节点上部署 Prometheus MySQL Exporter，主要功能如下：

1.  **高效分发模式 (Local-to-Remote)**
    *   采用“控制端下载 -> 推送至节点”的模式。
    *   只需 Ansible 机器下载一次安装包，即可分发到所有内网节点，无需每台服务器具备外网访问权限。

2.  **自动化账户管理**
    *   **数据库层**：自动创建专用的 MySQL 监控用户 `mysqld_exporter`，并仅授予最小必要权限（`PROCESS`, `REPLICATION CLIENT`, `SELECT`）。
    *   **系统层**：自动创建无登录权限的系统用户 `prometheus` 用于运行服务，提高安全性。

3.  **非侵入式安全配置**
    *   创建独立的隐藏配置文件 `/etc/.mysqld_exporter.cnf` 存储监控凭证。
    *   **零干扰**：完全不修改 MySQL 服务器的主配置文件 `/etc/my.cnf`，确保数据库原有配置的完整性。

4.  **Systemd 服务化管理**
    *   配置 `mysqld_exporter` 为 Systemd 服务。
    *   支持开机自启、后台运行及标准的服务管理命令（start/stop/restart）。

5.  **自动健康检查**
    *   部署完成后自动检测 `9104` 端口连通性。
    *   自动验证 `mysql_up` 指标值，确保 Exporter 能成功连接并采集到数据库数据。

