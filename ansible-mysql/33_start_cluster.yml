---
# ============================================================
# ç¬¬ä¸€æ­¥ï¼šå¯åŠ¨ Master èŠ‚ç‚¹
# ============================================================
- hosts: mysql_master
  gather_facts: no
  become: yes  # ğŸ’¡ æ–°å¢
  vars_files:
    - secrets.yml

  tasks:
    - name: å¯åŠ¨ Master MySQL æœåŠ¡
      service:
        name: mysqld
        state: started

    - name: ç­‰å¾… Master 3306 ç«¯å£å°±ç»ª
      wait_for:
        port: 3306
        delay: 2
        timeout: 60

    - name: æ‰“å° Master çŠ¶æ€
      debug:
        msg: "Master å·²å¯åŠ¨å¹¶ç›‘å¬ 3306 ç«¯å£ã€‚"

# ============================================================
# ç¬¬äºŒæ­¥ï¼šå¯åŠ¨ Slave èŠ‚ç‚¹å¹¶æ£€æŸ¥å¤åˆ¶
# ============================================================
- hosts: mysql_slave
  gather_facts: no
  become: yes  # ğŸ’¡ æ–°å¢
  vars_files:
    - secrets.yml

  tasks:
    - name: å¯åŠ¨ Slave MySQL æœåŠ¡
      service:
        name: mysqld
        state: started

    - name: ç­‰å¾… Slave 3306 ç«¯å£å°±ç»ª
      wait_for:
        port: 3306
        delay: 2
        timeout: 60

    # æ˜¾å¼æ‰§è¡Œä¸€æ¬¡ START SLAVE (é˜²æ­¢é…ç½®äº† skip-slave-start)
    - name: ç¡®ä¿å¤åˆ¶çº¿ç¨‹å·²å¯åŠ¨ (START SLAVE)
      shell: >
        mysql -uroot -p"{{ root_pass }}" -e "START SLAVE;"
      ignore_errors: yes

    - name: æ£€æŸ¥å¤åˆ¶çŠ¶æ€ (IO å’Œ SQL çº¿ç¨‹)
      # ğŸ’¡ ä¼˜åŒ– grepï¼Œåªæ˜¾ç¤ºå…³é”®çš„ä¸¤è¡Œ Yes
      shell: >
        mysql -uroot -p"{{ root_pass }}" -e "SHOW SLAVE STATUS\G" | grep -E "Slave_(IO|SQL)_Running:"
      register: slave_status
      changed_when: false

    - name: æ˜¾ç¤ºå¤åˆ¶çŠ¶æ€æ£€æŸ¥ç»“æœ
      debug:
        msg:
          - "èŠ‚ç‚¹ {{ inventory_hostname }} çŠ¶æ€:"
          - "{{ slave_status.stdout_lines }}"